# Lab2 report #

[TOC]

## 练习1 ##

[练习1.1]请在实验报告中简要说明你的设计实现过程。

- 首先根据default_pmm.c文件开头的大段英文注释，一步步修改几个函数。
- `default_init`无需修改
- `default_init_memmap`需要设置page的初始值，比如把`p->flags`置为`PG_property`以使其有效，可以通过SetPageProperty函数进行设置。然后设置`p->property`，第一页为该块中空闲页的总数，其他页设为0。`p->page_link`也只有第一页需要设置，用`list_add`加入链表里。
- 在实现`allocate`和`free`函数时，要注意新链表项的添加位置，保持环形链表从`free_list`开始按照内存顺序排列。
- 在实际测试的时候，对于一些特殊情况比如：当链表为空时再free一个进去怎么处理、当一个free块能与前后两个已有空闲块都能合并时怎么处理。这些花费了较多的时间去调试，也说明了之前的spoc作业的代码并不完美。

**与参考答案的不同:**

- 在`default_init_memmap`中，参考答案将空闲内存块链表的建立函数`list_add`放在了循环里，这让我难以理解，不是应该只有一块的开头一页才需要放在链表里吗，所以我这里并还是按照原先的默认版本，将`list_add`放在循环外面。
- 在完成`allocate`和`free`函数时，我进一步确定了参考答案的做法是与要求不符的，要求是连续的空闲页面组织成空闲块，仅空闲块的第一页需要插入空闲链表里，而且参考答案对于`flags`的`Property`位的设置也是混乱的。
- 作出的一点优化是在`free`函数中，当base的地址小于当前检索的链表项p的地址时，可以提前退出。

[练习1.2]你的first fit算法是否有进一步的改进空间？

- 并没有想到，想到了我就改了。

## 练习2 ##

[练习2.1]请在实验报告中简要说明你的设计实现过程。

- 找到页目录表入口，用`PDX`宏，加上pgdir作为基址可算出入口地址。
- 通过与`PTE_P`宏进行与运算得出是否是present，接着初始化相关变量的值。
- 再通过与相应宏进行或运算，设置读写权限。
- 最后再把转换为内核虚拟地址的值进行返回。

[练习2.2]请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处。

- 根据mmu.h里的宏：

```
/* page table/directory entry flags */
#define PTE_P           0x001                   // Present
#define PTE_W           0x002                   // Writeable
#define PTE_U           0x004                   // User
#define PTE_PWT         0x008                   // Write-Through
#define PTE_PCD         0x010                   // Cache-Disable
#define PTE_A           0x020                   // Accessed
#define PTE_D           0x040                   // Dirty
#define PTE_PS          0x080                   // Page Size
#define PTE_MBZ         0x180                   // Bits must be zero
#define PTE_AVAIL       0xE00                   // Available for software use
```

- 可以看出从低往高的位依次为，是否存在、是否可写、是否用户可以访问、是否采用写直达策略（用于cache写回）、是否可用Cache、是否被访问过、是否被修改过、页的大小、空白区、数据区。

[练习2.3]如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

- 当发生缺页时，硬件首先发出一个中断，并通过CR0~CR3寄存器保存异常的信息和当前的程序运行状态，然后需要通过idt找到对应的中断处理例程的地址并跳转到那里去执行处理这个异常的程序。

## 练习3 ##

[练习3.1]请在实验报告中简要说明你的设计实现过程。请回答如下问题：

- 跟练习2的过程类似，参照英文注释，先看页表地址是否present，再由`pte2page`得到对应页的指针，进行free操作，再把页表项进行释放`*ptep = 0;`并把快表里的引用通过`tlb_invalidate`给去除。

[练习3.2]数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

- `struct Page`的全局变量`pages`就表示的是物理内存中的页，也就是页表和页目录表中的表项指示的物理地址页，表项本身也存在其中。

[练习3.3]如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？

- 可以发现内核虚拟地址仅是在物理地址上加了`KERNBASE`，所以只需把这个宏设为0即可。

## 重要知识点 ##

- 涉及了内存中页的组织方式，通过二级页表的形式进行组织，并使用一个全局变量pages管理一个大的页链表来表示实际的物理页内存。
- 在删除用完的页后需要处理PTE，包括重置TLB、释放对应的页等。
- 没有涉及到的包括段机制的实现，而且虚拟地址也只是单纯物理地址加上`KERNBASE`，并没有体现出虚拟地址比物理地址多的情况。不过由于实验本身性质决定，老师也说过，实验并不太涉及段机制。


